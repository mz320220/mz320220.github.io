<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>jmap命令配合MAT工具分析java内存泄露情况 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="今天测试同学压测的时候又反馈内存有0.4%个百分点的上浮，其实之前用top命令观察了一段时间没什么问题。如果存在内存泄露的问题内存使用率应该会持续增加，而不是压了一个晚上也可以保持稳定。 :sweat: 不过两台服务器上一个项目的进程内存占用的确有一点点差别，保险起见dump堆转储文件分析看看，也学习一下。">
<meta property="og:type" content="article">
<meta property="og:title" content="jmap命令配合MAT工具分析java内存泄露情况">
<meta property="og:url" content="http://example.com/2018/12/07/jmap%E5%91%BD%E4%BB%A4%E9%85%8D%E5%90%88MAT%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90java%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%83%85%E5%86%B5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="今天测试同学压测的时候又反馈内存有0.4%个百分点的上浮，其实之前用top命令观察了一段时间没什么问题。如果存在内存泄露的问题内存使用率应该会持续增加，而不是压了一个晚上也可以保持稳定。 :sweat: 不过两台服务器上一个项目的进程内存占用的确有一点点差别，保险起见dump堆转储文件分析看看，也学习一下。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/93522148.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/223989.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/53428060.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/58536573.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/37832446.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/40088292.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/76005603.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/81909733.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/29004956.jpg">
<meta property="og:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/97387390.jpg">
<meta property="article:published_time" content="2018-12-07T03:14:05.000Z">
<meta property="article:modified_time" content="2019-04-22T02:02:27.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="tools">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/93522148.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-jmap命令配合MAT工具分析java内存泄露情况" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/07/jmap%E5%91%BD%E4%BB%A4%E9%85%8D%E5%90%88MAT%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90java%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%83%85%E5%86%B5/" class="article-date">
  <time class="dt-published" datetime="2018-12-07T03:14:05.000Z" itemprop="datePublished">2018-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux-Learning/">Linux Learning</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      jmap命令配合MAT工具分析java内存泄露情况
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天测试同学压测的时候又反馈内存有0.4%个百分点的上浮，其实之前用top命令观察了一段时间没什么问题。如果存在内存泄露的问题内存使用率应该会持续增加，而不是压了一个晚上也可以保持稳定。 :sweat: 不过两台服务器上一个项目的进程内存占用的确有一点点差别，保险起见dump堆转储文件分析看看，也学习一下。</p>
<span id="more"></span>

<h2 id="一-内存监控检视"><a href="#一-内存监控检视" class="headerlink" title="一. 内存监控检视"></a>一. 内存监控检视</h2><p>目前系统在测试环境压测时内存检测如下图，这种比较稳定的一般不存在内存泄露的问题：</p>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/93522148.jpg" alt="uws"></p>
<p>典型的可能存在内存泄露的监控图如下：</p>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/223989.jpg" alt="内存泄漏"></p>
<h2 id="二、jmap命令"><a href="#二、jmap命令" class="headerlink" title="二、jmap命令"></a>二、jmap命令</h2><p>jmap命令是jdk自带的小工具，可以打印分析java进程的共享对象内存映射、堆内存的细节等。</p>
<p>jmap命令可以获得运行中的jvm的堆的快照，从而可以：</p>
<ul>
<li>离线分析堆，以检查内存泄漏，检查一些严重影响性能的大对象的创建；</li>
<li>检查系统中什么对象最多，各种对象所占内存的大小等等；</li>
<li>可以使用jmap生成Heap Dump文件后抓取到本地进一步分析。</li>
</ul>
<blockquote>
<p><strong>什么是堆Dump</strong></p>
<p>堆Dump是反应Java堆使用情况的内存镜像，其中主要包括系统信息、虚拟机属性、完整的线程Dump、所有类和对象的状态等。 一般，在内存不足、GC异常等情况下，我们就会怀疑有内存泄露。这个时候我们就可以制作堆Dump来查看具体情况。</p>
</blockquote>
<h3 id="1-命令概述"><a href="#1-命令概述" class="headerlink" title="1.命令概述"></a>1.命令概述</h3><p>在shell中输入jmap有很完整的命令介绍：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[app@VM_101_178_centos irps-uws]$ jmap</span><br><span class="line">Usage:</span><br><span class="line">    jmap [option] &lt;pid&gt;</span><br><span class="line">        (to connect to running process)</span><br><span class="line">    jmap [option] &lt;executable &lt;core&gt;</span><br><span class="line">        (to connect to a core file)</span><br><span class="line">    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;</span><br><span class="line">        (to connect to remote debug server)</span><br><span class="line"></span><br><span class="line">where &lt;option&gt; is one of:</span><br><span class="line">    &lt;none&gt;               to print same info as Solaris pmap</span><br><span class="line">    #打印jvm的heap情况</span><br><span class="line">    -heap                to print java heap summary</span><br><span class="line">    #打印jvm的heap直方图：类型、对象数量、占用大小等，:live-可选是打印存活对象</span><br><span class="line">    -histo[:live]        to print histogram of java object heap; if the &quot;live&quot;</span><br><span class="line">                         suboption is specified, only count live objects</span><br><span class="line">    -clstats             to print class loader statistics</span><br><span class="line">    #显示在 F-Queue 队列等待 Finalizer 线程执行 finalize 方法的对象 </span><br><span class="line">    -finalizerinfo       to print information on objects awaiting finalization</span><br><span class="line">    #输出jvm堆内存信息到文件</span><br><span class="line">    -dump:&lt;dump-options&gt; to dump java heap in hprof binary format</span><br><span class="line">                         dump-options:</span><br><span class="line">                           live         dump only live objects; if not specified,</span><br><span class="line">                                        all objects in the heap are dumped.</span><br><span class="line">                           format=b     binary format	#dump命令可选参数，以二进制输出</span><br><span class="line">                           file=&lt;file&gt;  dump heap to &lt;file&gt; #命名输出文件</span><br><span class="line">                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</span><br><span class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo</span><br><span class="line">                         to force a heap dump or histogram when &lt;pid&gt; does not</span><br><span class="line">                         respond. The &quot;live&quot; suboption is not supported</span><br><span class="line">                         in this mode.</span><br><span class="line">    -h | -help           to print this help message</span><br><span class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</span><br></pre></td></tr></table></figure>

<h3 id="2-详细说明"><a href="#2-详细说明" class="headerlink" title="2.详细说明"></a>2.详细说明</h3><h4 id="2-1-jmap-heap-pid"><a href="#2-1-jmap-heap-pid" class="headerlink" title="2.1 jmap -heap pid"></a>2.1 jmap -heap pid</h4><p>打印pid的整体堆栈信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">一般先使用top命令查看内存占用情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash">然后按大写字母M，以mem占用排序pid，再使用jmp进一步分析</span></span><br><span class="line">[app@VM_101_178_centos irps-uws]$ jmap -heap 65067</span><br><span class="line">Attaching to process ID 65067, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.152-b16</span><br><span class="line"></span><br><span class="line">using parallel threads in the new generation.#新生代采用的是并行线程处理方式</span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Concurrent Mark-Sweep GC#同步并行垃圾回收方式</span><br><span class="line"></span><br><span class="line">Heap Configuration:#堆配置情况</span><br><span class="line">   MinHeapFreeRatio         = 40 #最小堆使用比例</span><br><span class="line">   MaxHeapFreeRatio         = 70 #最大堆使用比例</span><br><span class="line">   MaxHeapSize              = 2147483648 (2048.0MB) #最大堆空间大小</span><br><span class="line">   NewSize                  = 805306368 (768.0MB)	#新生代分配大小</span><br><span class="line">   MaxNewSize               = 805306368 (768.0MB)	#最大可新生代分配大小</span><br><span class="line">   OldSize                  = 1342177280 (1280.0MB)	#老生代大小</span><br><span class="line">   NewRatio                 = 2	#新生代比例</span><br><span class="line">   SurvivorRatio            = 8	#新生代与suvivor的比例</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 134217728 (128.0MB)</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:#堆使用情况</span><br><span class="line">New Generation (Eden + 1 Survivor Space):#新生代（伊甸区 + survior空间）</span><br><span class="line">   capacity = 724828160 (691.25MB)</span><br><span class="line">   used     = 283548752 (270.4131622314453MB)</span><br><span class="line">   free     = 441279408 (420.8368377685547MB)</span><br><span class="line">   39.11944480744236% used</span><br><span class="line">Eden Space:#伊甸区</span><br><span class="line">   capacity = 644349952 (614.5MB)</span><br><span class="line">   used     = 283111232 (269.99591064453125MB)</span><br><span class="line">   free     = 361238720 (344.50408935546875MB)</span><br><span class="line">   43.937495629704024% used</span><br><span class="line">From Space:#survior1区</span><br><span class="line">   capacity = 80478208 (76.75MB)</span><br><span class="line">   used     = 437520 (0.4172515869140625MB)</span><br><span class="line">   free     = 80040688 (76.33274841308594MB)</span><br><span class="line">   0.5436502761095277% used</span><br><span class="line">To Space:#survior2 区</span><br><span class="line">   capacity = 80478208 (76.75MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 80478208 (76.75MB)</span><br><span class="line">   0.0% used</span><br><span class="line">concurrent mark-sweep generation:#老生代使用情况</span><br><span class="line">   capacity = 1342177280 (1280.0MB)</span><br><span class="line">   used     = 97188168 (92.68585968017578MB)</span><br><span class="line">   free     = 1244989112 (1187.3141403198242MB)</span><br><span class="line">   7.241082787513733% used</span><br><span class="line"></span><br><span class="line">33675 interned Strings occupying 4006736 bytes.</span><br></pre></td></tr></table></figure>

<h4 id="2-2-jmap-finalizerinfo-pid"><a href="#2-2-jmap-finalizerinfo-pid" class="headerlink" title="2.2 jmap -finalizerinfo pid"></a>2.2 jmap -finalizerinfo pid</h4><p>打印等候回收的对象的信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[app@VM_101_178_centos irps-uws]$ jmap -finalizerinfo 65067</span><br><span class="line">Attaching to process ID 65067, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.152-b16</span><br><span class="line">Number of objects pending for finalization: 0	#0个对象在等候被回收</span><br></pre></td></tr></table></figure>

<h4 id="2-3-jmap-histo-pid"><a href="#2-3-jmap-histo-pid" class="headerlink" title="2.3 jmap -histo pid"></a>2.3 jmap -histo pid</h4><p>打印每个class的实例数目,内存占用,类全名信息. VM的内部类名字开头会加上前缀<code>*</code>. 如果live子参数加上后,只统计活的对象数量. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"> #</span><span class="bash">-histo命令会打印大量实例，最好和less配合使用</span></span><br><span class="line"> [app@VM_101_178_centos irps-uws]$ jmap -histo 65067|less</span><br><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:       1915748      208902184  [C</span><br><span class="line">   2:        729935       86852936  [B</span><br><span class="line">   3:        491930       51925552  [Ljava.lang.Object;</span><br><span class="line">   4:        670703       32193744  java.util.HashMap</span><br><span class="line">   5:        349710       30774480  java.lang.reflect.Method</span><br><span class="line">   6:        139541       20728016  [I</span><br><span class="line">   7:        242339       20377456  [Ljava.util.HashMap$Node;</span><br><span class="line">   8:        800805       19219320  java.lang.String</span><br><span class="line">   9:        551565       17650080  java.util.HashMap$Node</span><br><span class="line">  10:        931898       16330024  [Ljava.lang.Class;</span><br><span class="line">  11:        348377       13935080  java.util.HashMap$KeyIterator</span><br><span class="line">  12:        175761       12654792  java.lang.reflect.Field</span><br><span class="line">......</span><br><span class="line"><span class="meta">#</span><span class="bash">instance 是对象的实例个数</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">bytes 是总占用的字节数</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">class name 对应的就是 Class 文件里的 class 的标识</span> </span><br><span class="line">B 代表 byte</span><br><span class="line">C 代表 char</span><br><span class="line">D 代表 double</span><br><span class="line">F 代表 float</span><br><span class="line">I 代表 int</span><br><span class="line">J 代表 long</span><br><span class="line">Z 代表 boolean</span><br><span class="line">前边有 [ 代表数组， [I 就相当于 int[]</span><br><span class="line">对象用 [L + 类名表示</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">补充常用指令配合使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash">输出到a.log文件中，可以隔段时间输出并对比观察gc回收的情况</span></span><br><span class="line">jmap -histo:live pid&gt;a.log </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">只统计存活对象情况，ps：这个命令执行，JVM会先触发gc，然后再统计信息。</span></span><br><span class="line">jmap -histo:live pid </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看对象数最多的对象，并按降序排序输出：</span></span><br><span class="line">jmap -histo &lt;pid&gt;|grep alibaba|sort -k 2 -g -r|less #alibaba为需要搜索的对象</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看占用内存最多的最象，并按降序排序输出：</span></span><br><span class="line">jmap -histo &lt;pid&gt;|grep alibaba|sort -k 3 -g -r|less</span><br></pre></td></tr></table></figure>

<h4 id="2-4-jmap-dump-live-format-b-file-filename-pid"><a href="#2-4-jmap-dump-live-format-b-file-filename-pid" class="headerlink" title="2.4 jmap -dump:live,format=b,file=filename pid"></a>2.4 jmap -dump:live,format=b,file=filename pid</h4><p>jmap -dump命令用于生成堆转储文件，其中的live、format指令均可选。一般生成MAT分析的文件以<code>.hprof</code>的后缀结尾。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">输出堆转储文件到dumpfile.hprof</span></span><br><span class="line">[app@VM_101_178_centos irps-uws]$ jmap -dump:live,format=b,file=dumpfile.hprof 65067</span><br><span class="line">Dumping heap to /data/appsystems/irps-uws/dumpfile.hprof ...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个命令执行，JVM会将整个heap的信息dump写入到一个文件，heap如果比较大的话，就会导致这个过程比较耗时，并且执行的过程中为了保证dump的信息是可靠的，所以会暂停应用。</p>
</blockquote>
<h2 id="三、利用MAT检查内存泄露"><a href="#三、利用MAT检查内存泄露" class="headerlink" title="三、利用MAT检查内存泄露"></a>三、利用MAT检查内存泄露</h2><p>dump了文件到服务器上，使用scp或sz命令从Linux环境下载到本地环境。</p>
<h3 id="1-MAT下载安装"><a href="#1-MAT下载安装" class="headerlink" title="1.MAT下载安装"></a>1.MAT下载安装</h3><ul>
<li><p>将MAT当做eclipse的插件进行安装：启动Eclipse –&gt; Help –&gt; Eclipse Marketplace，然后搜索Memory Analyzer，安装，重启eclipse即可。</p>
</li>
<li><p>将MAT作为一个独立的软件进行安装：去官网<a target="_blank" rel="noopener" href="http://www.eclipse.org/mat/downloads.php">http://www.eclipse.org/mat/downloads.php</a>，根据操作系统版本下载最新的MAT。下载后解压就可以运行了。</p>
</li>
</ul>
<p>推荐第二种方式哈 :cocktail:</p>
<h3 id="2-MAT配置"><a href="#2-MAT配置" class="headerlink" title="2.MAT配置"></a>2.MAT配置</h3><p>MAT 软件版本解压后目录内有个MemoryAnalyzer.ini文件，该文件里面有个Xmx参数，该参数表示最大内存占用量，默认为1024m，根据堆转储文件大小修改该参数即可。</p>
<ul>
<li>MemoryAnalyzer.ini中的参数一般默认为-vmargs– Xmx1024m，这就够用了。假如你机器的内存不大，改大该参数的值，会导致MemoryAnalyzer启动时，报错:Failed to create the Java Virtual Machine。</li>
<li>当你导出的dump文件的大小大于你配置的1024m（说明1中，提到的配置：-vmargs– Xmx1024m），MAT输出分析报告的时候，会报错：An internal error occurred during: “Parsing heap dump from XXX”。适当调大说明1中的参数即可。</li>
</ul>
<h3 id="3-使用MAT分析堆转储文件"><a href="#3-使用MAT分析堆转储文件" class="headerlink" title="3.使用MAT分析堆转储文件"></a>3.使用MAT分析堆转储文件</h3><p>打开mat后，选择File -&gt; Open Heap Dump找到下载到本地的dump文件打开。</p>
<ul>
<li>加载后首页如下，主要关注Leak Suspects功能-泄露分析。</li>
</ul>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/53428060.jpg" alt="MAT首页"></p>
<ul>
<li>点击Leak Suspects，.hprof文件所在文件夹 :file_folder: 会生成一个压缩包。如果需要和同事一起分析这个内存问题，只需要把这个小小的 zip 包发给他就可以了，不需要把整个堆文件发给他。并且整个报告是一个 HTML 格式的文件，用浏览器就可以打开。</li>
</ul>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/58536573.jpg" alt="MAT ZIP"></p>
<ul>
<li>进入suspects页面如下，MAT工具会列出来可能存在内存泄露的位置。现在看唯一的可能泄露是jar包中的并不是程序代码导致，所以程序不存在内存泄露的问题。</li>
</ul>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/37832446.jpg" alt="Leak Suspects"></p>
<ul>
<li>假如存在内存泄露我们可以点击Details进一步分析，参考网上的blog如下。这个截图其实就说明是系统代码的问题了。</li>
</ul>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/40088292.jpg" alt="suspect"></p>
<ul>
<li>在详情页面<strong>Shortest Paths To the Accumulation Point</strong>表示GC root到内存消耗聚集点的最短路径，如果某个内存消耗聚集点有路径到达GC root，则该内存消耗聚集点不会被当做垃圾被回收。（所以重点关注哦）</li>
</ul>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/76005603.jpg" alt="内存泄露~"></p>
<ul>
<li><p>在All Accumulated Objects by Class列举了该对象所存储的所有内容。其实从这个地方已经可以大概分析出问题了，EventInfo这个对象数量不太正常。</p>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/81909733.jpg" alt="EventInfo"></p>
</li>
<li><p>为了更精确的定位，可以抓取间隔一段时间的两个dump文件进行对比分析，更加容易定位内存泄露的位置。</p>
</li>
</ul>
<blockquote>
<p>MAT同时打开两个堆转储文件，分别打开Histogram，如下图。在下图中方框1按钮用于对比两个Histogram，对比后在方框2处选择Group By package，然后对比各对象的变化。不难发现heap3.hprof比heap6.hprof少了64个eventInfo对象</p>
</blockquote>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/29004956.jpg" alt="compare dump file"></p>
<ul>
<li>最终分析结果如下：</li>
</ul>
<p><img src="http://martintop-image.oss-cn-shenzhen.aliyuncs.com/18-12-7/97387390.jpg" alt="result"></p>
<blockquote>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wanghuiqi2008/article/details/50724676">使用 Eclipse Memory Analyzer 进行堆转储文件分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/opensource/os-cn-ecl-ma/index.html">利用内存分析工具（Memory Analyzer Tool，MAT）分析java项目内存泄露</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/12/07/jmap%E5%91%BD%E4%BB%A4%E9%85%8D%E5%90%88MAT%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90java%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%83%85%E5%86%B5/" data-id="ckwiyxcps000b9lzj5atgdcy2" data-title="jmap命令配合MAT工具分析java内存泄露情况" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tools/" rel="tag">tools</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/12/11/jvm%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98&%E7%9B%91%E6%8E%A7-jps%20jstat%20jstack%20jmap%20jinfo/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          jvm性能调优&amp;监控-jps jstat jstack jmap jinfo
        
      </div>
    </a>
  
  
    <a href="/2018/11/22/Linux%E7%8E%AF%E5%A2%83%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E5%92%8C%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Linux环境性能优化和问题排查</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JDK%E6%BA%90%E7%A0%81/">JDK源码</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Learning/">Linux Learning</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/git/IDE/">IDE</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo%E5%BB%BA%E7%AB%99/">hexo建站</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/" rel="tag">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Github/" style="font-size: 10px;">Github</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 10px;">基础知识</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/04/22/java.io%E5%8C%85%E4%B9%8BBits%E7%B1%BB%E6%BA%90%E7%A0%81/">java.io包之Bits类源码</a>
          </li>
        
          <li>
            <a href="/2019/04/18/Git%E5%8F%8Aintellij-idea%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/">git及intellij idea设置代理</a>
          </li>
        
          <li>
            <a href="/2019/04/17/%E5%A6%82%E4%BD%95%E9%98%85%E8%AF%BBJDK%E6%BA%90%E7%A0%81/">如何阅读JDK源码</a>
          </li>
        
          <li>
            <a href="/2018/12/11/jvm%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98&%E7%9B%91%E6%8E%A7-jps%20jstat%20jstack%20jmap%20jinfo/">jvm性能调优&amp;监控-jps jstat jstack jmap jinfo</a>
          </li>
        
          <li>
            <a href="/2018/12/07/jmap%E5%91%BD%E4%BB%A4%E9%85%8D%E5%90%88MAT%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90java%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%83%85%E5%86%B5/">jmap命令配合MAT工具分析java内存泄露情况</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>